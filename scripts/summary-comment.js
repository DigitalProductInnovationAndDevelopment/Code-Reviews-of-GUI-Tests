#!/usr/bin/env node
/**
 * summary-comment.js
 *
 * Posts or updates a single â€œGUI Test Reviewâ€ comment on a PR.
 * The comment aggregates:
 *   â€¢ Playwright metrics
 *   â€¢ Prettier + ESLint summaries
 *   â€¢ Flow-diagram / dashboard link
 *   â€¢ Checklist
 */

const fs = require('fs');
const path = require('path');
const { Octokit } = require('@octokit/core');

/* â”€â”€â”€ helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const readJSON = (fp, fallback = {}) => {
  try { return JSON.parse(fs.readFileSync(fp, 'utf8')); }
  catch { return fallback; }
};
const icon = (ok, warn = false) => (ok ? 'âœ…' : warn ? 'âš ï¸' : 'âŒ');

/* â”€â”€â”€ GitHub context â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const token = process.env.GITHUB_TOKEN;
if (!token) { console.error('GITHUB_TOKEN missing'); process.exit(1); }

const event = JSON.parse(fs.readFileSync(process.env.GITHUB_EVENT_PATH, 'utf8'));
if (!event.pull_request) { console.log('Not a PR event; skipping comment.'); process.exit(0); }

const owner = event.repository.owner.login;
const repo  = event.repository.name;
const pr    = event.number;

/* â”€â”€â”€ load artefact summaries â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const ART = 'artifacts';
const play   = readJSON(path.join(ART, 'playwright-summary.json'));
const eslint = readJSON(path.join(ART, 'eslint-summary.json'));
const prett  = readJSON(path.join(ART, 'prettier-summary.json'));
const checklist = readJSON(path.join(ART, 'checklist.json')).md || '';

/* URL to the live dashboard, injected by the workflow */
const webUrl = process.env.WEB_REPORT_URL;

/* â”€â”€â”€ compose comment body â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const body = `
# ðŸ” GUI Test Review Report

## âœ… Test Execution Summary
| Metric | Value | Status |
| ------ | ----- | ------ |
| **Total Tests** | ${play.total   ?? 0} | |
| **Passed**      | ${play.passed  ?? 0} | ${icon((play.passed ?? 0) === (play.total ?? 0), (play.failed ?? 0) === 0)} |
| **Failed**      | ${play.failed  ?? 0} | ${icon((play.failed ?? 0) === 0)} |
| **Skipped**     | ${play.skipped ?? 0} | ${icon((play.skipped ?? 0) === 0, true)} |
| **Pass Rate**   | ${play.pass_rate ?? 0}% | ${icon((play.pass_rate ?? 0) >= 95, (play.pass_rate ?? 0) >= 80)} |
| **Duration**    | ${play.duration ?? 0} ms | |

---

## ðŸŽ¨ Code Style (Prettier)
| Check | Result |
|-------|--------|
| **Style Issues** | ${prett.has_issues ? 'âŒ Found' : 'âœ… None'} |
| **Files Affected** | ${prett.files_with_issues ?? 0} |
| **Total Changes**  | ${prett.total_changes    ?? 0} |

---

## ðŸ“‹ Code Quality (ESLint)
| Metric | Count | Status |
| ------ | ----- | ------- |
| **Files**    | ${eslint.total_files ?? 0} | |
| **Errors**   | ${eslint.errors      ?? 0} | ${icon((eslint.errors ?? 0) === 0)} |
| **Warnings** | ${eslint.warnings    ?? 0} | ${icon((eslint.warnings ?? 0) === 0, true)} |
| **Fixable**  | ðŸ”´ ${eslint.fixable_errors ?? 0} / ðŸŸ¡ ${eslint.fixable_warnings ?? 0} | |

**Top Rules:**  
${eslint.error_rules   ?? 'None'}  
${eslint.warning_rules ?? 'None'}

**Files Needing Attention:**  
${eslint.problematic_files ?? 'None'}

---

## ðŸ“Š Test Flow Diagram
${webUrl ? `ðŸ‘‰ **[Open the full HTML dashboard â†—](${webUrl})**`
         : 'Flowchart is attached as workflow artefact.'}

---

## âœ… Checklist
${checklist}

---

_Automated comment generated by the GUI Test Review workflow._
`;

/* â”€â”€â”€ create or update the sticky comment â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const octokit = new Octokit({ auth: token });

(async () => {
  const { data: comments } = await octokit.request(
    'GET /repos/{owner}/{repo}/issues/{issue_number}/comments',
    { owner, repo, issue_number: pr }
  );

  const existing = comments.find(
    c => c.user.type === 'Bot' &&
         c.body.startsWith('# ðŸ” GUI Test Review Report')
  );

  if (existing) {
    await octokit.request(
      'PATCH /repos/{owner}/{repo}/issues/comments/{comment_id}',
      { owner, repo, comment_id: existing.id, body }
    );
    console.log('ðŸ”„ Updated GUI-test summary comment.');
  } else {
    await octokit.request(
      'POST /repos/{owner}/{repo}/issues/{issue_number}/comments',
      { owner, repo, issue_number: pr, body }
    );
    console.log('ðŸ’¬ Created GUI-test summary comment.');
  }
})().catch(err => {
  console.error(err);
  process.exit(1);
});

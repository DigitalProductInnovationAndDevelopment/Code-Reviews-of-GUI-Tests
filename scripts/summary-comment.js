#!/usr/bin/env node
/**
 * summary-comment.js
 *
 * Creates or updates a â€œstickyâ€ PR comment that summarises:
 *   â€¢ Playwright metrics
 *   â€¢ ESLint + Prettier results
 *   â€¢ (optionally) a link to the published HTML dashboard
 *
 * Reads JSON summaries from ./artifacts, which the workflow
 * downloads before invoking this script.
 */

const fs = require('fs');
const path = require('path');
const { Octokit } = require('@octokit/core');

// â”€â”€ helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function readJson(fp, fallback = {}) {
  try { return JSON.parse(fs.readFileSync(fp, 'utf8')); }
  catch { return fallback; }
}
function icon(ok, warn = false) { return ok ? 'âœ…' : warn ? 'âš ï¸' : 'âŒ'; }

// â”€â”€ GitHub context â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const token = process.env.GITHUB_TOKEN;
if (!token) {
  console.error('GITHUB_TOKEN is missing');
  process.exit(1);
}
const octokit = new Octokit({ auth: token });

const event = JSON.parse(fs.readFileSync(process.env.GITHUB_EVENT_PATH, 'utf8'));
if (!event.pull_request) {
  console.error('Not a pull_request event â€“ aborting.');
  process.exit(0);
}
const { owner, name: repo } = event.repository;
const prNumber = event.pull_request.number;

// â”€â”€ load summaries produced by previous steps â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ART = 'artifacts';
const play  = readJson(path.join(ART, 'playwright-summary.json'));
const eslint = readJson(path.join(ART, 'eslint-summary.json'));
const prett  = readJson(path.join(ART, 'prettier-summary.json'));

// optional: injected by workflow
const webUrl = process.env.WEB_REPORT_URL;

// â”€â”€ compose comment body â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const body = `
# ðŸ” GUI Test Review Report

## âœ… Test Execution Summary
| Metric | Value | Status |
| ------ | ----- | ------ |
| **Total Tests** | ${play.total   ?? 0} | |
| **Passed**      | ${play.passed  ?? 0} | ${icon((play.passed  ?? 0) === (play.total ?? 0), (play.failed ?? 0) === 0)} |
| **Failed**      | ${play.failed  ?? 0} | ${icon((play.failed  ?? 0) === 0)} |
| **Skipped**     | ${play.skipped ?? 0} | ${icon((play.skipped ?? 0) === 0, true)} |
| **Pass Rate**   | ${play.pass_rate ?? 0}% | ${icon((play.pass_rate ?? 0) >= 95, (play.pass_rate ?? 0) >= 80)} |
| **Duration**    | ${play.duration ?? 0} ms | |

---

## ðŸŽ¨ Code Style (Prettier)
| Check | Result |
|-------|--------|
| **Style Issues** | ${prett.has_issues ? 'âŒ Found' : 'âœ… None'} |
| **Files Affected** | ${prett.files_with_issues ?? 0} |
| **Total Changes**  | ${prett.total_changes    ?? 0} |

---

## ðŸ“‹ Code Quality (ESLint)
| Metric | Count | Status |
| ------ | ----- | ------- |
| **Files**    | ${eslint.total_files ?? 0} | |
| **Errors**   | ${eslint.errors      ?? 0} | ${icon((eslint.errors   ?? 0) === 0)} |
| **Warnings** | ${eslint.warnings    ?? 0} | ${icon((eslint.warnings ?? 0) === 0, true)} |
| **Fixable**  | ðŸ”´ ${eslint.fixable_errors ?? 0} / ðŸŸ¡ ${eslint.fixable_warnings ?? 0} | |

**Top Rules:**  
${eslint.error_rules   ?? 'None'}  
${eslint.warning_rules ?? 'None'}

**Files Needing Attention:**  
${eslint.problematic_files ?? 'None'}

---

## ðŸ“Š Test Flow Diagram
${
  webUrl
    ? `ðŸ‘‰ **[Open the full HTML report&nbsp;â†—](${webUrl})**`
    : 'Visual diagram is attached as workflow artifact **gui-artifacts/flowchart.png**.'
}

---

_Automated comment generated by the GUI Test Review workflow._
`;

// â”€â”€ create / update sticky comment â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(async () => {
  const { data: comments } = await octokit.request(
    'GET /repos/{owner}/{repo}/issues/{issue_number}/comments',
    { owner, repo, issue_number: prNumber }
  );

  const existing = comments.find(
    (c) => c.user.type === 'Bot' && c.body.startsWith('# ðŸ” GUI Test Review Report')
  );

  if (existing) {
    await octokit.request(
      'PATCH /repos/{owner}/{repo}/issues/comments/{comment_id}',
      { owner, repo, comment_id: existing.id, body }
    );
    console.log('ðŸ”„ Updated GUI-test summary comment.');
  } else {
    await octokit.request(
      'POST /repos/{owner}/{repo}/issues/{issue_number}/comments',
      { owner, repo, issue_number: prNumber, body }
    );
    console.log('ðŸ’¬ Created GUI-test summary comment.');
  }
})().catch((err) => {
  console.error(err);
  process.exit(1);
});

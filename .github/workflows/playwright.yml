name: Test Reviewdog

on:
  pull_request:
    branches: [main]

jobs:
  test-reviewdog:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      checks: write
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - uses: reviewdog/action-setup@v1
      
      # Test 1: ESLint with reviewdog action (this one exists)
      - name: Test 1 - ESLint via reviewdog action
        uses: reviewdog/action-eslint@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          eslint_flags: 'tests/**/*.{js,ts,tsx}'
          level: warning
          reporter: github-pr-review
          filter_mode: nofilter
      
      # Test 2: Manual prettier + reviewdog
      - name: Test 2 - Manual prettier + reviewdog
        env:
          REVIEWDOG_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Create a test file with formatting issues
          cat > tests/test-format.js << 'EOF'
          const   x    =    1
          const y=2
          if(x>y){console.log("x is bigger")}
          EOF
          
          # Format it
          npx prettier --write tests/test-format.js
          
          # Get the diff
          git diff tests/test-format.js
          
          # Send to reviewdog
          git diff tests/test-format.js | \
            reviewdog -f=diff -name=test-manual -reporter=github-pr-review
      
      # Test 3: Check environment
      - name: Test 3 - Debug environment
        run: |
          echo "=== PR Info ==="
          echo "PR Number: ${{ github.event.pull_request.number }}"
          echo "Base: ${{ github.base_ref }}"
          echo "Head: ${{ github.head_ref }}"
          echo "Token exists: ${{ secrets.GITHUB_TOKEN != '' }}"
          
          echo "=== Reviewdog test ==="
          reviewdog -version
          
          # Test with local reporter
          echo "Testing local reporter..."
          cat > test.diff << 'EOF'
          diff --git a/test.js b/test.js
          index 1234567..abcdefg 100644
          --- a/test.js
          +++ b/test.js
          @@ -1,1 +1,1 @@
          -const x = 1
          +const x = 1;
          EOF
          
          cat test.diff | reviewdog -f=diff -reporter=local
      
      # Test 4: Limited diff approach
      - name: Test 4 - Your actual prettier flow
        env:
          REVIEWDOG_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Run prettier on all files
          npx prettier --write "tests/**/*.{js,ts,tsx,json}"
          
          # Check diff size
          DIFF_SIZE=$(git diff -- tests | wc -l)
          echo "Diff size: $DIFF_SIZE lines"
          
          if [ $DIFF_SIZE -gt 1000 ]; then
            echo "Large diff detected. Creating summary..."
            
            # Get just the first few files
            FILES=$(git diff --name-only -- tests | head -5)
            
            for file in $FILES; do
              echo "Processing $file..."
              git diff -- "$file" | head -50 | \
                reviewdog -f=diff -name=prettier-$file -reporter=github-pr-review
            done
          else
            echo "Normal diff size. Processing all..."
            git diff -- tests | \
              reviewdog -f=diff -name=prettier-all -reporter=github-pr-review
          fi
          
          # Cleanup
          git checkout -- .
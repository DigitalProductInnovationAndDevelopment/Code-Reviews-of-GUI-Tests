name: GUI Test Review (Prettier Inline Suggest Debug)

on:
  pull_request:
    branches: [main]

jobs:
  review-lint:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      # Checkout code
      - name: Checkout code
        uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      # Setup Node
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with: { node-version: 18 }

      # Install dependencies
      - name: Install NPM dependencies
        run: npm install

      # Download reviewdog static binary for suggestion support (with debug!)
      - name: Download reviewdog static binary
        run: |
          curl -sSL -o reviewdog.tgz https://github.com/reviewdog/reviewdog/releases/download/v0.17.3/reviewdog_0.17.3_Linux_x86_64.tar.gz
          tar -xzvf reviewdog.tgz
          sudo mv reviewdog /usr/local/bin/reviewdog
          which reviewdog
          reviewdog -version

      # Show git status before linting
      - name: Show git status before linting
        run: |
          echo "==== git status ===="
          git status
          echo "==== git diff (before) ===="
          git diff

      # Prettier fix and diff
      - name: Run Prettier and show diff
        run: |
          npx prettier --write "tests/**/*.{js,ts,tsx,json}"
          echo "==== git status (after prettier) ===="
          git status
          echo "==== git diff (after prettier) ===="
          git diff -- tests > prettier.diff || true
          cat prettier.diff

      # reviewdog suggest (with debug logs)
      - name: Prettier reviewdog suggest (with debug)
        env:
          REVIEWDOG_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "==== reviewdog binary ===="
          which reviewdog
          reviewdog -version
          echo "==== cat prettier.diff ===="
          cat prettier.diff
          if [ -s prettier.diff ]; then
            echo "==== running reviewdog ===="
            cat prettier.diff | reviewdog -f=diff -name=prettier -reporter=github-pr-suggest -filter-mode=nofilter -level=info -fail-on-error=false
          else
            echo "No Prettier issues found or no diff."
          fi

      # Show event context for further debugging
      - name: Dump event.json
        run: cat $GITHUB_EVENT_PATH

      # Run ESLint (optional, for completeness)
      - name: ESLint (just to show errors, not as reviewdog)
        run: npx eslint "tests/**/*.{js,ts,tsx}" || true

      # Final output
      - name: Final git status
        run: git status
